#!usr/bin/env ruby

require 'cri'
require 'typhoeus'
require 'yaml'
require 'json'
require 'fileutils'

require_relative '../lib/unipept'

Signal.trap("PIPE", "EXIT")
Signal.trap("INT", "EXIT")

module Unipept
  class Taxa2lca < ApiRunner

    def mapping
      {"taxa2lca" => "taxa2lca"}
    end

    def peptide_iterator(peptides, &block)
      block.call(peptides.to_a, 0)
    end

    def batch_size
      raise "NOT NEEDED FOR TAXA2LCA"
    end

  end

  class Pept2prot < ApiRunner

    def mapping
      {"pept2prot" => "pept2prot"}
    end

    def download_xml(result)
      if options[:xml]
        FileUtils.mkdir_p(options[:xml])
        result.first.each do |prot|
          File.open(options[:xml] + "/#{prot['uniprot_id']}.xml", "wb") do |f|
            f.write Typhoeus.get("http://www.uniprot.org/uniprot/#{prot['uniprot_id']}.xml").response_body
          end
        end
      end
    end

    def batch_size
      10
    end
  end

  class Taxonomy < ApiRunner
    def mapping
      {"taxonomy" => "taxonomy"}
    end
  end
end

root_cmd = Cri::Command.new_basic_root.modify do
  name 'unipept'
  flag :v, :version, "print version"
  flag :q, :quiet, "don't show update messages"
  option :i, :input, "input file", :argument => :required
  option :o, :output, "output file", :argument => :required
  option :f, :format, "output format (available: #{Unipept::Formatter.available.join "," }) (default: #{Unipept::Formatter.default})", :argument => :required

  # Configuration options
  option nil, "host", "Override host setting", argument: :required

  run do |opts, args, cmd|
    if opts[:version]
      puts File.read(File.join(File.dirname(__FILE__), "..", "VERSION"))
    end
  end
end

root_cmd.define_command('config') do
  usage 'config attr [value]'

  run do |opts, args, cmd|
    config = Unipept::Configuration.new
    if args.size > 1
      config[args.first] = args[1]
      config.save
    elsif args.size == 1
      puts config[args.first]
    end
  end

end

root_cmd.define_command('pept2taxa') do
  usage       'pept2taxa [options]'
  aliases     :s
  summary     'Single Peptide Search'
  description 'Search Unipept for the given peptide and return taxons'

  flag :e, :equate, "equate I and L"
  option :s, :select, "select the attributes", :argument => :required, :multiple => true
  option :a, :extra, "Show full lineage"
  option :x, :xml, "Download taxonomy from NCBI as xml (specify output filename)", :argument => :required

  runner Unipept::ApiRunner
end

root_cmd.define_command('pept2lca') do
  usage       'pept2lca [options]'
  aliases     :l
  summary     'Give lowest common ancestor for given peptide'
  description 'Search Unipept for the given peptide and return the lowest common ancestor'

  flag :e, :equate, "equate I and L"
  option :s, :select, "select the attributes", :argument => :required, :multiple => true
  option :a, :extra, "Show full lineage"

  runner Unipept::ApiRunner
end

root_cmd.define_command('taxa2lca') do
  usage       'taxa2lca [options]'
  aliases     :t
  summary     'Give lowest common ancestor for taxon ids'
  description 'Search Unipept for the given taxon ids and return the lowest common ancestor'

  option :s, :select, "select the attributes", :argument => :required, :multiple => true
  option :a, :extra, "Show full lineage"

  runner Unipept::Taxa2lca
end

root_cmd.define_command('pept2prot') do
  usage       'pept2prot [options]'
  aliases     :p
  summary     'Give protein information for given peptides'
  description 'Search Unipept for the given peptides and return the lowest common ancestor'

  flag :e, :equate, "equate I and L"
  option :s, :select, "select the attributes", :argument => :required, :multiple => true
  option :x, :xml, "download uniprot record in specified directory", :argument => :required
  flag :a, :extra, "include all information. WARNING: will take much longer!"

  runner Unipept::Pept2prot
end

root_cmd.define_command('taxonomy') do
  usage       'taxonomy [options]'
  aliases     :tax
  summary     'Give NCBI taxonomy information on given input taxon ids'
  description 'Returns information for each input taxon id'

  option :s, :select, "select the attributes", :argument => :required, :multiple => true
  flag :a, :extra, "include all information. WARNING: will take much longer!"

  runner Unipept::Taxonomy
end

root_cmd.run(ARGV)
